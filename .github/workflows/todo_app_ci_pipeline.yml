name: Continuous Integration
on:
  push:
    paths-ignore:
      - 'README.md'
      - 'notes.txt'
      - 'documentation/*'
  pull_request:
    branches:
      -  master

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build docker test image
        run: docker build --target test --tag my-test-image .
      - name: Run unit and integration tests
        run: docker run --env-file .env.test my-test-image todo_app/tests
      - name: Run e2e tests
        env:
          mongo_db_connection: "${{secrets.MONGO_DB_CONNECTION}}"
          mongo_db_name: "${{secrets.MONGO_DB_NAME}}"
          git_client_id: "${{secrets.GIT_CLIENT_ID}}"
          git_client_secret: "${{secrets.GIT_CLIENT_SECRET}}"
        run: docker run -e mongo_db_connection -e mongo_db_name -e git_client_id -e git_client_secret my-test-image todo_app/e2e_tests

  publish:
    name: Push Image to DockerHub
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/exercise-9' && github.event_name == 'push'
    steps:
    - uses: actions/checkout@v2
    - name: Build and push to Heroku
      id: heroku
      uses: jctaveras/heroku-deploy@v1.0.0 
      with:
        email: ${{ secrets.HEROKU_EMAIL }} 
        api_key: ${{ secrets.HEROKU_API_KEY }} 
        app_name: ${{ secrets.HEROKU_APP_NAME }} 
        dockerfile: './' # set the path to the folder where the Dockerfile is located
        options: '--target production --tag jaisalpatel836/todo_app:latest --tag jaisalpatel836/todo_app:"$GITHUB_SHA"' # current version of action doesn't support this - need to upgrade - only works since prod is last base to build from
    - uses: docker/login-action@v1
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    - run: docker build --target production --tag jaisalpatel836/todo_app:latest --tag jaisalpatel836/todo_app:"$GITHUB_SHA" .
    - run: docker push jaisalpatel836/todo_app --all-tags
    
    
